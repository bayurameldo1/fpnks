<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Farcaster Punks — Mint</title>
  <meta name="description" content="Farcaster Punks — mint directly from Warpcast or your wallet." />
  <style>
    :root{
      --bg-1: #050214;
      --bg-2: #0b0720;
      --card: rgba(255,255,255,0.03);
      --muted: #b9b6cb;
      --accent: #7c3aed;
      --glass: rgba(255,255,255,0.04);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      color:#fff;
      background: radial-gradient(circle at 10% 10%, rgba(124,58,237,0.06), transparent 10%), linear-gradient(180deg,var(--bg-1),var(--bg-2));
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    .container{max-width:1100px;margin:36px auto;padding:20px}
    .card{background:var(--card);border-radius:14px;padding:20px;display:flex;gap:18px;align-items:flex-start}
    .left{flex:1}
    .right{width:320px;text-align:center}
    .logo{width:96px;height:96px;border-radius:12px;object-fit:cover;display:block}
    h1{margin:0;font-size:22px}
    p.lead{margin:6px 0 0;color:var(--muted)}
    .controls{margin-top:18px;display:flex;gap:12px;flex-wrap:wrap}
    .btn{
      background:linear-gradient(180deg,var(--accent),#5f2de6);
      color:#fff;padding:10px 14px;border-radius:10px;border:0;font-weight:700;cursor:pointer;
      box-shadow:0 6px 18px rgba(0,0,0,0.35)
    }
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);font-weight:600}
    .muted{color:var(--muted);font-size:13px;margin-top:10px}
    .small{font-size:13px;color:var(--muted)}
    .log{margin-top:12px;padding:12px;background:var(--glass);border-radius:8px;color:#e6e3ee;font-family:monospace;font-size:13px;max-height:220px;overflow:auto}
    .socials{display:flex;gap:8px;margin-top:14px}
    .socials a{display:inline-flex;align-items:center;justify-content:center;width:38px;height:38px;border-radius:10px;background:rgba(255,255,255,0.02);text-decoration:none}
    .priceBox{margin-top:14px;background:rgba(255,255,255,0.02);padding:12px;border-radius:10px}
    a.inline{color:var(--accent);text-decoration:none}
    footer{margin-top:18px;color:var(--muted);font-size:13px}
    @media(max-width:880px){
      .card{flex-direction:column}
      .right{width:100%}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card" role="main">
      <div class="left">
        <div style="display:flex;gap:14px;align-items:center">
          <img class="logo" id="logoImg" src="/assets/logo.png" alt="Farcaster Punks logo" onerror="this.style.display='none'"/>
          <div>
            <h1>Farcaster Punks</h1>
            <p class="lead">Mint on Base — works in browser (wallet) or in Warpcast (in-app relayer).</p>
          </div>
        </div>

        <div class="controls" style="align-items:center">
          <button id="connectBtn" class="btn ghost">Connect Wallet</button>
          <button id="mintBtn" class="btn">Mint Now</button>
          <button id="mintRelayerBtn" class="btn ghost">Mint via Relayer</button>
          <a id="openSeaBtn" class="btn ghost inline" href="#" target="_blank" rel="noopener noreferrer">View on OpenSea</a>
        </div>

        <div class="priceBox" id="priceBox">
          <div class="small">Price: <strong id="mintPrice">—</strong> • Status: <span id="mintStatus">checking…</span></div>
          <div class="small">Max per wallet: <span id="maxPerWallet">—</span></div>
        </div>

        <div class="muted" id="hint">Initializing…</div>

        <div class="log" id="log" aria-live="polite"></div>

        <div class="socials" style="margin-top:10px">
          <a id="twitterLink" href="https://x.com/farcasterpunks" target="_blank" title="Twitter (X)"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#9aa0ff" stroke-width="1.2"><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53A4.48 4.48 0 0 0 12 8.09v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5A4.5 4.5 0 0 0 23 3z"></path></svg></a>
          <a id="farcasterLink" href="https://warpcast.com" target="_blank" title="Farcaster (Warpcast)"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#9aa0ff" stroke-width="1.2"><path d="M12 2L19 8v8l-7 6-7-6V8l7-6z"></path></svg></a>
          <a id="openSeaLink" href="#" target="_blank" title="OpenSea"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#9aa0ff" stroke-width="1.2"><path d="M3 3h18v18H3z"></path></svg></a>
          <a id="magicLink" href="https://magiceden.io" target="_blank" title="Magic Eden"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#9aa0ff" stroke-width="1.2"><circle cx="12" cy="12" r="9"></circle></svg></a>
        </div>

        <footer>
          <div>Contract: <a id="contractLink" class="inline" href="#" target="_blank"></a></div>
          <div style="margin-top:6px">Open in Warpcast to mint in-app (frame uses postUrl in manifest).</div>
        </footer>
      </div>

      <div class="right">
        <img src="/assets/logo.png" alt="preview" style="width:220px;border-radius:12px;object-fit:cover" />
        <div style="margin-top:12px" class="small">Limited • Base</div>
      </div>
    </div>
  </div>

  <!-- Ethers v6 (ESM) -->
  <script type="module">
    import { ethers } from 'https://cdn.jsdelivr.net/npm/ethers@6.9.0/dist/ethers.esm.min.js';

    /***********************
     * CONFIG - edit these *
     ***********************/
    const CONFIG = {
      NFT_CONTRACT: '0x4d749dc4016936759e437b1a01d2ef0f0690e651',
      SEADROP_ADDRESS: '0xa7a8e04195ab59c68e9d4fca396b6a4c42a446d7',
      POST_URL: '/api/mint', // endpoint for relayer (must match manifest .well-known/postUrl)
      OPENSEA_URL: 'https://opensea.io/collection/farcaster-punks-59466883/overview',
      BASESCAN_TX_PREFIX: 'https://basescan.org/tx/',
      BASESCAN_ADDRESS_PREFIX: 'https://basescan.org/address/'
    };
    /************************/

    // Elements
    const connectBtn = document.getElementById('connectBtn');
    const mintBtn = document.getElementById('mintBtn');
    const mintRelayerBtn = document.getElementById('mintRelayerBtn');
    const openSeaBtn = document.getElementById('openSeaBtn');
    const logEl = document.getElementById('log');
    const hintEl = document.getElementById('hint');
    const mintPriceEl = document.getElementById('mintPrice');
    const mintStatusEl = document.getElementById('mintStatus');
    const maxPerWalletEl = document.getElementById('maxPerWallet');
    const contractLinkEl = document.getElementById('contractLink');
    const openSeaLink = document.getElementById('openSeaLink');

    // Init UI
    contractLinkEl.href = CONFIG.BASESCAN_ADDRESS_PREFIX + CONFIG.NFT_CONTRACT;
    contractLinkEl.textContent = CONFIG.NFT_CONTRACT;
    openSeaBtn.href = CONFIG.OPENSEA_URL;
    openSeaLink.href = CONFIG.OPENSEA_URL;

    // State
    let provider = null;
    let signer = null;

    function inWarpcast() {
      try {
        const w = window;
        return !!(w.__FARCASTER__ || w.farcaster || w.Frame || w.Warpcast);
      } catch (e) { return false; }
    }

    function appendLog(msg) {
      const time = new Date().toLocaleTimeString();
      logEl.innerHTML = `[${time}] ${escapeHtml(String(msg))}
` + logEl.innerHTML;
    }

    function escapeHtml(s) {
      return s.replaceAll('<','&lt;').replaceAll('>','&gt;');
    }

    async function readPublicDrop() {
      try {
        const providerRead = new ethers.JsonRpcProvider('https://mainnet.base.org'); // public Base RPC; change if needed
        const read = new ethers.Contract(CONFIG.SEADROP_ADDRESS, [
          "function getPublicDrop(address nftContract) view returns (uint80 mintPrice, uint48 startTime, uint48 endTime, uint16 maxTotalMintableByWallet, uint16 feeBps, bool restrictFeeRecipients)"
        ], providerRead);

        const pub = await read.getPublicDrop(CONFIG.NFT_CONTRACT);
        const mintPrice = BigInt(pub[0].toString ? pub[0].toString() : pub[0]);
        const start = Number(pub[1]);
        const end = Number(pub[2]);
        const maxPer = Number(pub[3]);
        const feeBps = Number(pub[4]);
        const restrict = Boolean(pub[5]);

        const now = Math.floor(Date.now() / 1000);
        const status = (start <= now && now <= end) ? 'Active' : (now < start ? 'Not started' : 'Ended');

        const mintEth = Number(ethers.formatUnits(mintPrice, 'ether'));
        mintPriceEl.textContent = mintEth + ' ETH';
        mintStatusEl.textContent = status + (restrict ? ' • fee recipients restricted' : '');
        maxPerWalletEl.textContent = maxPer;

        appendLog(`Public drop read: price=${mintEth} ETH start=${new Date(start*1000).toISOString()} end=${new Date(end*1000).toISOString()} maxPer=${maxPer}`);
        return { mintPrice, start, end, maxPer, restrict };
      } catch (err) {
        appendLog('Failed to read publicDrop: ' + (err?.message || err));
        mintPriceEl.textContent = '—';
        mintStatusEl.textContent = 'unknown';
        maxPerWalletEl.textContent = '—';
        return null;
      }
    }

    // Initialize provider detection
    async function init() {
      if (typeof window.ethereum !== 'undefined') {
        provider = new ethers.BrowserProvider(window.ethereum);
        connectBtn.style.display = 'inline-block';
        appendLog('Wallet provider detected in browser.');
        hintEl.textContent = 'Wallet provider available — you can connect and sign transactions in browser. Or open this page inside Warpcast to mint without wallet.';
      } else {
        provider = null;
        connectBtn.style.display = 'none';
        if (inWarpcast()) {
          hintEl.textContent = 'Opened inside Warpcast — press Mint Now in the frame to mint via relayer.';
        } else {
          hintEl.textContent = 'No wallet detected. Connect wallet or open inside Farcaster (Warpcast) to mint via relayer.';
  }
}
